var mysql = require("mysql");
var connection = mysql.createConnection({
	host	:'localhost',
	user	:'root',
	password:'root',
	database:'eatSafe'
});

exports.register = function(email,password,callback) {
	if(!(email.indexOf("@")<1 || email.lastIndexOf(".")< email.indexOf("@")+2 || email.lastIndexOf(".")+2 >= email.length)) {
		//if (password.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/) /*&& password.length > 4 && password.match(/[0-9]/) && password.match(/.[!,@,#,$,%,^,&,*,?,_,~]/*/)) {
		connection.connect();
		connection.beginTransaction(function(err) {
			if (err) { 
				console.log(err);
				throw err; }

			var sql    = 'SELECT count(*) AS count FROM users WHERE username = ' + connection.escape(email);			
			connection.query(sql, function(err, result) {
				console.log("err = "+err);
				if (result[0].count > 0) {					
					callback({'response':"User already exist", 'res':false});
				} else {
					var values = {username: email, password: password};
					connection.query('INSERT INTO users SET ?', values, function(err,result){
						if (err) {
							console.log(err);
							connection.rollback(function() {
								throw err;
							});
						}
						connection.commit(function(err) {
							if (err) { 
								connection.rollback(function() {
									throw err;
								});
							}
							console.log(result.insertId);
							if (result.insertId != null) {
								connection.end();
								callback({'response':"Success", 'res':true});
							}
						});
					});
				}
			});			
		});
	} else {
		callback({'response':"Email Not Valid", 'res':false});
	}
}