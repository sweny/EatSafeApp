var request = require("request");
var mysql = require("mysql");
var connection = mysql.createConnection({
	host	:'localhost',
	user	:'root',
	password:'root',
	database:'eatSafe'
});
var allergy_ingredients = null;
var allergy = null;
var ingredients = null;
//https://api.nutritionix.com/v1_1/item?upc=49000036756&appId=[YOURID]&appKey=[YOURKEY];
//curl -v  -X GET "https://api.nutritionix.com/v1_1/item?upc=52200004265&appId=e859ad7e&appKey=c6e37a4aaa1592dc5cc3dea8675ff078"
exports.upcDecoder = function(upcCode, username, callback) {
	console.log("in upcDecoder func upcCode: "+upcCode);
	console.log ("username in parent "+username);
	var baseURL = 'https://api.nutritionix.com/v1_1/item?upc=';
	var app_Id = 'e859ad7e';
	var app_Key = 'c6e37a4aaa1592dc5cc3dea8675ff078';
	var url = baseURL + upcCode + '&appId='+ app_Id+"&appKey="+app_Key
	console.log("URL created : "+url);
	request({
			uri: url,
			method : 'GET',
	}, function(error, response, body)
			{
				console.log("in success call of ajax method for nutritionix and data is "+body);	
				var data = JSON.parse(body);
				if (!data.status_code){
					ingredients = data.nf_ingredient_statement;
					console.log("ingredients - "+ingredients);								
					connection.connect();
					connection.beginTransaction(function(err) {
						if (err) { 
							console.log(err);
							throw err; 
							}
						console.log("username - "+username);
						var sql    = 'SELECT allergy AS allergy FROM ehr_user_data WHERE user_id = ' + connection.escape(username);			
						connection.query(sql, function(err, results) {
							console.log("err = "+err);												
							if (results.length == 0) {	
								console.log("allergy here = "+results[0].allergy);
								callback({'response':"You can consume the product.", 'res':true});
							} else {
								console.log("allergy = "+results[0].allergy);
								allergy = results[0].allergy;
								allergy_ingredients = allergy.toString().split(",");
								console.log("allergy_ingredients = "+allergy_ingredients);
								for (i in allergy_ingredients){
									console.log("allergy_ingredient = "+allergy_ingredients[i]);
									console.log ("ingredients.indexOf(allergy_ingredient) : "+ingredients.toString().indexOf(allergy_ingredients[i]));
									if(ingredients.toString().indexOf(allergy_ingredients[i]) > -1) {
										callback({'response':"This product contains "+allergy_ingredients[i]+" that you are allergic to!", 'res':true});
									}
								}
								callback({'response':"You can consume the product.", 'res':true});							
							}
						});			
					});
				} else {
					callback({'response':"Item not found in database!", 'res':true});
				}				
		});
}